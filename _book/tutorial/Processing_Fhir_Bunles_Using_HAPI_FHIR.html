<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>Processing_Fhir_Bunles_Using_HAPI_FHIR | fhir-in-action</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../tutorial/SMART_on_FHIR_Part1.html" />
    
    
    <link rel="prev" href="../tutorial/FHIR_Connectathon7_for_Java_Dummies.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="1.2" data-basepath=".." data-revision="1411482096111">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         前言
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         FHIR简介
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" data-path="tutorial/FHIR_Connectathon7_for_Java_Dummies.html">
            
                
                    <a href="../tutorial/FHIR_Connectathon7_for_Java_Dummies.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                         FHIR_Connectathon7_for_Java_Dummies
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="1.2" data-path="tutorial/Processing_Fhir_Bunles_Using_HAPI_FHIR.html">
            
                
                    <a href="../tutorial/Processing_Fhir_Bunles_Using_HAPI_FHIR.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                         Processing_Fhir_Bunles_Using_HAPI_FHIR
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.3" data-path="tutorial/SMART_on_FHIR_Part1.html">
            
                
                    <a href="../tutorial/SMART_on_FHIR_Part1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                         SMART on_FHIR_Part1
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.4" data-path="tutorial/7thConnectathon_tracks.html">
            
                
                    <a href="../tutorial/7thConnectathon_tracks.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                         7th Connectathon tracks
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.5" data-path="tutorial/SMART_on_FHIR_adding_OAuth2.html">
            
                
                    <a href="../tutorial/SMART_on_FHIR_adding_OAuth2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                         SMART on FHIR – adding OAuth2
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.6" data-path="tutorial/fhir_and_oauth2.html">
            
                
                    <a href="../tutorial/fhir_and_oauth2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                         FHIR and OAuth2
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.7" data-path="tutorial/a_simple_oauth_client.html">
            
                
                    <a href="../tutorial/a_simple_oauth_client.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                         A simple OAuth client
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.8" data-path="tutorial/fhir_oauth2_and_the_mobile_client.html">
            
                
                    <a href="../tutorial/fhir_oauth2_and_the_mobile_client.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                         FHIR, Oauth2 and the Mobile client
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.9" data-path="tutorial/fhir_and_openid_connect.html">
            
                
                    <a href="../tutorial/fhir_and_openid_connect.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.9.</b>
                        
                         FHIR and OpenID Connect
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.10" data-path="tutorial/fhir_securing_an_ecosystem.html">
            
                
                    <a href="../tutorial/fhir_securing_an_ecosystem.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.10.</b>
                        
                         FHIR: Securing an ecosystem
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >fhir-in-action</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_4655">
                    
                        <p><a href="http://fhirblog.com/2014/08/18/processing-fhir-bundles-using-hapi" target="_blank">原文链接:Processing FHIR Bundles using HAPI</a></p>
<p><a href="http://fhirblog.com/2014/06/13/fhir-transactions-the-search-functionality" target="_blank">另外一篇文章:FHIR transactions: the Search functionality</a></p>
<h2 id="fhir-search">FHIR 事务:search功能</h2>
<p>FHIR中是通过<a href="http://www.hl7.org/implement/standards/fhir/http.html#transaction" target="_blank">transaction</a>来实现资源批量处理的.服务器对每个资源都单独处理,看起来就像是每个资源都是单独发送/提交的(除了批量更新的情况之外 要么都成功 要么都失败).
对于服务器而言,要处理bundle中每个资源的引用是很困难的,不论是新添加的资源或者是已经存在的.
其中有一点,服务器首先要判断这个资源服务器上存在不存在.
用例描述:
通过FHIR标准将某个可穿戴式设备(家用血糖仪)采集的血糖数据导入到数据仓库当中去.
血糖仪能够采集血糖数据,通过USB接口,利用桌面应用程序把数据取出来,发送给数据仓库.数据仓库期望
所存储的是结构化数据,这样子便于展示和临床决策支持之用.
思路:
大体上可以有多次操作和单次操作.</p>
<ol>
<li>首先向数据仓库发送查询请求,确保Patient和Device存在,不存在就新增.然后利用Observation来传输(POST方法)
每个血糖结果,在observation中加上对Patient和device的引用即可.</li>
<li>用一个bundle来表达整个与血糖相关的信息,其中包含一个Patient资源,一个Device资源,一个Observation资源
(用于记录每一项结果).     Observation.subject 是patient  ,  Observation.performer是Device.最终URL类如  POST [base] {?_format=[mime-type]}
客户端生成这个bundle的时候,Patient的ID和Device的ID应该如何赋值,鉴于血糖结果总是新添加的,Observation的ID使用cid:id即可.
对于Patient资源和Device资源而言,我们是已经给他们了一个id,但这个id又不是资源中的患者或设备的标识,假设我们给ID赋值为cid:ID的话 ,服务器会不断的新增一条患者记录,设备记录,
我们无法与可能之前就存在的记录进行关联.在标准中有如下<a href="www.hl7.org/implement/standards/fhir/http.html#transaction">一段话</a>,提出了解决这个问题的方法:<pre><code>The application constructing a bundle may not be sure whether a particular resource will already exist at the time that the transaction is executed; this is typically the case with reference resources such as patient and provider. In this case, the bundle should contain a candidate resource with a cid: identifier, and an additional search parameter using an Atom link:
</code></pre>也就是说.遇到这种情况,资源的id赋值为cid:id,另外在atom的link属性中增加一条如下<pre><code>&lt;link href=&quot;http://localhost/Patient?[parameters]&quot; rel=&quot;search&quot;/&gt;
</code></pre>服务器接收到这样的一条记录,首先依据href中那个的url和参数在服务器上进行检索有无匹配记录,如果有,
就直接使用服务器上的匹配记录,没有的话,就按原来的思路处理.如果发现多条记录,不进行处理,直接报异常.
如下是patient的实例片段:<pre><code>&lt;entry&gt;
&lt;title&gt;Patient details&lt;/title&gt;
&lt;id&gt;cid:patient@bundle&lt;/id&gt;
&lt;updated&gt;2014-05-28T22:12:21Z&lt;/updated&gt;
&lt;link href=&quot;http://localhost/Patient?identifier=PRP1660&quot; rel=&quot;search&quot;/&gt;
&lt;content type=&quot;text/xml&quot;&gt;
  &lt;Patient xmlns=&quot;http://hl7.org/fhir&quot;&gt;
      &lt;text&gt;
          &lt;status value=&quot;generated&quot;/&gt;
          &lt;div xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;Joe Bloggs&lt;/div&gt;
      &lt;/text&gt;
      &lt;identifier&gt;
          &lt;value value=&quot;PRP1660&quot;/&gt;
      &lt;/identifier&gt;
      &lt;name&gt;
          &lt;text value=&quot;Joe Bloggs&quot;/&gt;
      &lt;/name&gt;
  &lt;/Patient&gt;
&lt;/content&gt;
&lt;/entry&gt;
</code></pre></li>
<li>利用mailbox节点,我们给方法2中的bundle添加一个MessagHeader资源,使用MessageHeader.event 来
表示bundle是用来干嘛的.mailbox就能够正常处理了.</li>
<li>利用transaction节点,也就是服务器根节点,通过profile资源来定义bundle的内容.在事务transaction过程中,
可以识别出profile,使用预定义的处理方法,可能包含了校验和资源的更新操作.</li>
</ol>
<p>方法2是一种自定义方法,需要发送方接受方的协调,FHIR中暂时没有定义和描述此类服务的方式.
方法3 你要定义消息事件类型,添加消息头资源,发送方和接受方需要协调
方法4POSTing to the root (#4) is attractive –provided that the server knows how to perform the ‘search processing’ (i.e. recognize the search link for a resource in the bundle and process accordingly. We could possibly use a profile so that the server can validate the bundle first.
通用型的事务处理过程是很复杂的,一方面包括了ID的重写操作,另一方面也要照顾bundle中需要删除操作的资源.通过profle资源来约束限制事务的处理过程的行为,比方说,服务器识别出profile,将其作为某次transaction的基准,而不需要实现所有功能.</p>
<p>不论选取那种方式,都需要在响应时返回一个bundle,包含了各个资源,每个资源都会分配一个ID.
下面的代码是方式2的范例,仅供参考.</p>
<ul>
<li>GlucoseBundleProcessor迭代所有资源,更新其cid:id的引用,核对是否存在Patient Device资源.</li>
<li>该例中忽略了所有服务器想要的资源 显然是不科学的</li>
</ul>
<p>类的示例：</p>
<pre><code>public class GlucoseBundleProcessor {

    private MyMongo _myMongo;   //the database helper class

    public GlucoseBundleProcessor(MyMongo myMongo){
        _myMongo = myMongo;
    }

    //process with a Bundle...
    public List&lt;IResource&gt; processGlucoseBundle(Bundle bundle) {
        //generate a list of resources...
        List&lt;IResource&gt; theResources = new ArrayList&lt;IResource&gt;();    //list of resources in bundle
        for (BundleEntry entry : bundle.getEntries()) {
            theResources.add(entry.getResource());
        }
        return this.process(theResources);
    }


    //process with a List of resources
    public List&lt;IResource&gt; processGlucoseUploads(List&lt;IResource&gt; theResources) {
        return this.process(theResources);
    }


    //process a bundle of glucose results, adding them to the repository...
    private List&lt;IResource&gt; process(List&lt;IResource&gt; theResources) {
        Patient patient = null;     //this will be the patient resource. There should only be one....
        Device device = null;       //this will be the device resource. There should only be one....
        List&lt;IResource&gt; insertList = new ArrayList&lt;IResource&gt;();    //list of resource to insert...

        //First pass: assign all the CID:&#39;s to a new ID. For more complex scenarios, we&#39;d keep track of
        //the changes, but for this profile, we don&#39;t need to...
        //Note that this processing is highly specific to this profile !!! (For example, we ignore resources we don&#39;t expect to see)
        for (IResource resource : theResources) {
            String currentID = resource.getId().getValue();
            if (currentID.substring(0,4).equals(&quot;cid:&quot;)) {
                //Obviouslym the base URL should not be hard coded...
                String newID = &quot;http://myUrl/&quot; + java.util.UUID.randomUUID().toString();
                resource.setId(new IdDt(newID));    //and here&#39;s the new URL
            }

            //if this resource is a patient or device, then set the appropriate objects. We&#39;ll use these to set
            // the references in the Observations in the second pass. In real life we&#39;d want to be sure there is only one of each...
            if (resource instanceof Patient) {
                patient = (Patient) resource;
                //we need to see if there&#39;s already a patient with this identifier. If there is - and there is one,
                //then we use that Patient rather than adding a new one.
                // This could be triggered by a &#39;rel=search&#39; link on the bundle entry in a generic routine...
                IdentifierDt identifier = patient.getIdentifier().size() &gt;0 ? patient.getIdentifier().get(0) : null;
                if (identifier != null) {
                    List&lt;IResource&gt; lst = _myMongo.findResourcesByIdentifier(&quot;Patient&quot;,identifier);
                    if (lst.size() == 1) {
                        //there is a single patient with that identifier...
                        patient = (Patient) lst.get(0);
                        resource.setId(patient.getId());    //set the identifier in the list. We need to return this...
                    } else if (lst.size() &gt; 1) {
                        //here is where we ought to raise an error - we cannot know which one to use.
                    } else {
                        //if there isn&#39;t a single resource with this identifier, we need to add a new one
                        insertList.add(patient);
                    }
                } else {
                    insertList.add(patient);
                }
            }

            //look up a Device in the same way as as for a Patient
            if (resource instanceof Device) {
                device = (Device) resource;
                IdentifierDt identifier = device.getIdentifier().size() &gt;0 ? device.getIdentifier().get(0) : null;
                if (identifier != null) {
                    List&lt;IResource&gt; lst = _myMongo.findResourcesByIdentifier(&quot;Device&quot;, identifier);
                    if (lst.size() == 1) {
                        device = (Device) lst.get(0);
                        resource.setId(device.getId());    //set the identifier in the list. We need to retuen this...
                    } else {
                        insertList.add(device);
                    }
                } else {
                    insertList.add(device);
                }
            }

            if (resource instanceof Observation) {
                //we always add observations...
                insertList.add(resource);
            }
        }

        //Second Pass: Now we re-set all the resource references. This is very crude, and rather manual.
        // We also really ought to make sure that the patient and the device have been set.....
        for (IResource resource : theResources) {
            if (resource instanceof Observation) {
                Observation obs = (Observation) resource;

                //this will be the correct ID - either a new one from the bundle, or a pre-existing one...
                obs.setSubject(new ResourceReferenceDt(patient.getId()));

                //set the performer - there can be more than one in the spec, hence a list...
                List&lt;ResourceReferenceDt&gt; lstReferences = new ArrayList&lt;ResourceReferenceDt&gt;();
                lstReferences.add(new ResourceReferenceDt(device.getId()));
                obs.setPerformer(lstReferences);
            }
        }

        //Last pass - write out the resources
        for (IResource resource : insertList) {
            _myMongo.saveResource(resource);
        }

        //we return the bundle with the updated resourceID&#39;s - as per the spec...
        return theResources;
    }
}
</code></pre><p>代码示例</p>
<pre><code>@WebServlet(urlPatterns= {&quot;/fhir/service/glucoseprocessor&quot;}, displayName=&quot;Process Glucose bundle&quot;)
public class GlucoseResultServlet extends HttpServlet {

    private MyMongo _myMongo;
    private FhirContext _fhirContext;

    @Override
    public void init(ServletConfig config) throws ServletException {
        //get the &#39;global&#39; resources from the servlet context
        ServletContext ctx = config.getServletContext();
        _myMongo =  (MyMongo) ctx.getAttribute(&quot;mymongo&quot;);
        _fhirContext = (FhirContext) ctx.getAttribute(&quot;fhircontext&quot;);
    }

    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        PrintWriter out = response.getWriter();
        //first parse into a fhir bundle (need to check the mime type here. Should also check for _format paramters as well)
        //if we have to to this a lot, then a separate utility class would be good...

        Bundle bundle = null;
        IParser parser = null;
        String ct =  request.getHeader(&quot;content-type&quot;);
        if (ct.equals(&quot;application/xml+fhir&quot;)){
            parser = _fhirContext.newXmlParser();
            bundle = parser.parseBundle(request.getReader());
        } else if (ct.equals(&quot;application/json+fhir&quot;)){
            parser = _fhirContext.newJsonParser();
            bundle = parser.parseBundle(request.getReader());
        } else {
            OperationOutcome operationOutcome = new OperationOutcome();
            operationOutcome.getText().setDiv(&quot;Invalid content-type header: &quot; + ct);
            parser = _fhirContext.newXmlParser();
            response.setStatus(415);    //unsupported media type
            out.println(parser.encodeResourceToString(operationOutcome));
            return;
        }

        //now we have a bundle we can process it...
        GlucoseBundleProcessor glucoseBundleProcessor = new GlucoseBundleProcessor(_myMongo);
        //process the bundle, and get back the list of resources with updated ID&#39;s...
        List&lt;IResource&gt; resources = glucoseBundleProcessor.processGlucoseBundle(bundle);
        Bundle newBundle = new Bundle();
        newBundle.getTitle().setValue(&quot;Processed Glucose results&quot;);
        newBundle.setId(new IdDt(java.util.UUID.randomUUID().toString()));
        newBundle.setPublished(new InstantDt());
        for (IResource resource : resources) {
            newBundle.addResource(resource,_fhirContext,&quot;http://localServer/fhir&quot;);
        }

        response.setStatus(201);    //created
        out.println(parser.encodeBundleToString(newBundle));

    }



}
</code></pre>
                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../tutorial/FHIR_Connectathon7_for_Java_Dummies.html" class="navigation navigation-prev " aria-label="Previous page: FHIR_Connectathon7_for_Java_Dummies"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../tutorial/SMART_on_FHIR_Part1.html" class="navigation navigation-next " aria-label="Next page: SMART on_FHIR_Part1"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
